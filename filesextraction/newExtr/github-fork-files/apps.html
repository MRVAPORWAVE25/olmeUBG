<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Apps</title>
<link rel="stylesheet" href="../styles.css">
<style>
  /* Local adjustments while preserving the site's shared background */
  :root{ --accent:#00e0c6; }
  /* Allow this page to scroll even though the global stylesheet hides overflow */
  html,body{
    height:100%;
    margin:0;
    color:var(--accent);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;
    background:transparent;
    overflow:auto; /* enable vertical scrolling for the apps page */
    -webkit-overflow-scrolling: touch;
  }
  /* Ensure the shared animated canvas sits fixed behind content */
  #bg{ position:fixed; inset:0; z-index:0; pointer-events:none; }
  /* Bring page content above the canvas */
  .wrap{min-height:100vh;box-sizing:border-box;padding:18px;display:flex;flex-direction:column;gap:14px;align-items:center;position:relative;z-index:1;}
  .header{width:100%;max-width:980px;display:flex;flex-direction:column;align-items:center;gap:10px;padding-top:36px;position:relative;}
  .title{font-size:40px;font-weight:900;color:var(--accent);text-align:center;letter-spacing:0.6px;
    text-shadow:0 8px 30px rgba(0,224,198,0.08),0 0 26px rgba(102,240,224,0.08);}
  .controls{width:100%;max-width:980px;display:flex;gap:10px;align-items:center;justify-content:center;padding-top:6px}
  .search{width:100%;max-width:640px;height:46px;border-radius:12px;padding:10px 14px;border:1px solid rgba(255,255,255,0.04);
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));color:var(--accent);font-weight:700;font-size:16px;outline:none}
  .search::placeholder{ color: rgba(223,246,239,0.48); }

  /* back button */
  .back-btn{
    position:absolute;
    left:12px;
    top:12px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    height:40px;
    min-width:40px;
    padding:8px 10px;
    gap:8px;
    border-radius:10px;
    border:none;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06));
    color: #cfeee9;
    font-weight:700;
    cursor:pointer;
    box-shadow: 0 6px 18px rgba(0,0,0,0.45);
    z-index:3;
  }
  .back-btn:active{ transform: translateY(1px); }
  .grid{width:100%;max-width:1100px;display:grid;grid-template-columns:repeat(5,1fr);gap:14px;padding-top:12px}
  @media (max-width:1100px){ .grid{grid-template-columns:repeat(4,1fr);} }
  @media (max-width:860px){ .grid{grid-template-columns:repeat(3,1fr);} }
  @media (max-width:560px){ .grid{grid-template-columns:repeat(2,1fr);} }
  @media (max-width:380px){ .grid{grid-template-columns:repeat(1,1fr);} }
  .tile{border-radius:12px;padding:14px;height:120px;display:flex;flex-direction:column;align-items:center;justify-content:center;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04));border:1px solid rgba(255,255,255,0.03);cursor:pointer;font-weight:800}
  .tile:active{transform:translateY(1px)}
  .thumb{font-size:14px;color:var(--accent);text-align:center}
  .meta{font-size:12px;color:rgba(223,246,239,0.6);margin-top:8px;text-align:center}
  .hint{font-size:13px;color:rgba(223,246,239,0.6);text-align:center;margin-top:8px}

/* Modal preview for an app (iframe) */
.game-modal {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
.game-modal[aria-hidden="false"] { display: flex; }
.game-modal .scrim {
  position: absolute;
  inset: 0;
  background: rgba(2,6,8,0.75);
  backdrop-filter: blur(4px);
}
.game-modal .card {
  position: relative;
  width: min(92vw, 900px);
  height: min(78vh, 600px);
  background: linear-gradient(180deg, rgba(12,14,16,0.98), rgba(8,10,12,0.98));
  border-radius: 12px;
  box-shadow: 0 18px 60px rgba(0,0,0,0.6);
  overflow: hidden;
  border: 1px solid rgba(255,255,255,0.03);
  z-index: 2;
  display:flex;
  flex-direction:column;
}
.game-modal .card .top {
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
  padding:10px 12px;
  border-bottom:1px solid rgba(255,255,255,0.02);
}
.game-modal .card .title { font-weight:800; color:var(--accent); font-size:18px; }
.game-modal .card .close {
  background:transparent; border:none; color:#cfeee9; font-size:20px; line-height:1; padding:6px 8px; border-radius:8px; cursor:pointer;
}
.game-modal .card iframe {
  flex:1;
  border:0;
  width:100%;
  height:100%;
  background:transparent;
}
</style>
</head>
<body class="apps">

  <canvas id="bg"></canvas>

  <div class="wrap" role="main" aria-label="Apps">
    <div class="header">
      <button id="back-to-main" class="back-btn" aria-label="Back to main" title="Back to main">&larr; Back</button>
      <div class="title" id="page-title">Apps</div>
      <div class="controls">
        <input id="search" class="search" type="search" placeholder="Filter Apps" aria-label="Filter Apps" />
      </div>
    </div>

    <div id="grid" class="grid" role="list" aria-live="polite"></div>

    <div id="hint" class="hint">Tap an item to load a preview; the grid auto-adjusts when apps are added.</div>
  </div>

<script>
(function(){
  const grid = document.getElementById('grid');
  const search = document.getElementById('search');

  // apps registry: only one app remains on the apps page
  const apps = {
    thirtydollarwebsite:{title:'Thirty Dollar Website', desc:'Thirty Dollar Website — browser experience', key:'thirtydollarwebsite', url:'https://mspoi.github.io/seraph/apps/thirtydollarwebsite/index.html'},
    soundboard:{title:'Soundboard', desc:'Soundboard — quick audio clips & effects', key:'soundboard', url:'https://griffylock.neocities.org/soundboard'},
    webglfluids:{title:'WebGL Fluids', desc:'WebGL Fluids — interactive fluid simulation', key:'webglfluids', url:'https://mspoi.github.io/seraph/apps/fluidsim/index.html'},
    slik:{title:'Slik', desc:'Slik — generative silk drawing', key:'slik', url:'https://mspoi.github.io/seraph/apps/weavesilk/index.html'},
    // added: Jackbox.tv app
    jackboxtv:{title:'Jackbox.tv', desc:'Jackbox.tv — party game companion site', key:'jackboxtv', url:'https://griffylock.neocities.org/Jackbox.tv'},
    // added: Ruffle app
    ruffle:{title:'Ruffle', desc:'Ruffle — Flash player emulator (web)', key:'ruffle', url:'https://griffylock.neocities.org/Ruffle'},
    // added: Code Editor
    codeeditor:{title:'Code Editor', desc:'Code Editor — in-browser code editing', key:'codeeditor', url:'https://mrvaporwave25.github.io/Gams/g/codeeditor.html'},
    // added: (Seraph) EmulatorJS
    emulatorjs:{title:'(Seraph) EmulatorJS', desc:'(Seraph) EmulatorJS — web-based emulator frontend', key:'emulatorjs', url:'https://mspoi.github.io/seraph/apps/emulatorjs/index.html'},
    // added: Geometry.today
    geometrytoday:{title:'Geometry.today', desc:'Geometry.today — interactive geometry resources', key:'geometrytoday', url:'https://geometry.today/'},
    // added: Turbowarp (user request)
    turbowarp:{title:'Turbowarp', desc:'Turbowarp — Scratch mod and project player/editor', key:'turbowarp', url:'https://mspoi.github.io/seraph/apps/turbowarp/index.html'}
  };

  function renderGrid(filter=''){
    const q = (filter||'').trim().toLowerCase();
    grid.innerHTML = '';
    const keys = Object.keys(apps);
    const visible = keys.filter(k=>{
      const g = apps[k];
      return !q || g.title.toLowerCase().includes(q) || (g.desc && g.desc.toLowerCase().includes(q));
    });
    if(visible.length===0){
      const nr = document.createElement('div');
      nr.className='tile';
      nr.style.gridColumn='1/-1';
      nr.textContent='No apps found.';
      grid.appendChild(nr);
      return;
    }
    visible.forEach(k=>{
      const g = apps[k];
      const item = document.createElement('div');
      item.className='tile';
      item.tabIndex=0;
      item.dataset.key = k;
      const thumb = document.createElement('div'); thumb.className='thumb'; thumb.textContent = g.title;
      const meta = document.createElement('div'); meta.className='meta'; meta.textContent = g.desc;
      item.appendChild(thumb); item.appendChild(meta);
      item.addEventListener('click', ()=> showPreview(g));
      item.addEventListener('keydown', (e)=>{ if(e.key==='Enter') showPreview(g); });
      grid.appendChild(item);
    });
  }

  function showPreview(g){
    // Create or reuse an in-page modal that hosts a blob-backed iframe preview of the app
    let modal = document.getElementById('game-modal');
    if(!modal){
      modal = document.createElement('div');
      modal.id = 'game-modal';
      modal.className = 'game-modal';
      modal.setAttribute('aria-hidden','true');

      modal.innerHTML = `
        <div class="scrim" data-close="true" tabindex="-1"></div>
        <div class="card" role="dialog" aria-label="App preview">
          <div class="top">
            <div class="title"></div>
            <button class="close" aria-label="Close preview">&times;</button>
          </div>
          <iframe sandbox="allow-scripts allow-same-origin" scrolling="no" title="App preview"></iframe>
        </div>
      `;
      document.body.appendChild(modal);

      // close handlers
      modal.querySelectorAll('[data-close], .close').forEach(el=>{
        el.addEventListener('click', ()=> {
          closeModal();
        }, {passive:true});
      });

      window.addEventListener('keydown', (e)=>{
        if(e.key === 'Escape' && modal.getAttribute('aria-hidden') === 'false') closeModal();
      }, {passive:true});
    }

    const titleEl = modal.querySelector('.title');
    const cardEl = modal.querySelector('.card');
    const iframe = modal.querySelector('iframe');

    // Special sizing for some apps: make Geometry.today use a larger 720p-friendly preview
    if (g.key === 'geometrytoday' || (g.url && g.url.indexOf('geometry.today') !== -1)) {
      // responsive 720p: up to 1280x720, constrained to viewport
      cardEl.style.width = 'min(1280px, 92vw)';
      cardEl.style.height = 'min(720px, 80vh)';
      // ensure iframe fills the card and is scrollable so the site can scroll naturally
      iframe.style.width = '100%';
      iframe.style.height = '100%';
      try { iframe.setAttribute('scrolling', 'yes'); } catch (e) { /* ignore */ }
      // also allow touch scrolling on the iframe container if needed
      try { iframe.style.touchAction = 'auto'; } catch (e) {}
    } else {
      // Ensure iframe fills the card
      iframe.style.width = '100%';
      iframe.style.height = '100%';
    }

    // If the app provides a real URL, load it directly into the sandboxed iframe;
    if (g.url) {
      try {
        if (iframe._blobUrl) {
          URL.revokeObjectURL(iframe._blobUrl);
          iframe._blobUrl = null;
        }
      } catch (e){}
      iframe.src = g.url;
    } else {
      const previewHtml = `<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
        <title>${escapeHtml(g.title)}</title>
        <style>
          html,body{height:100%;margin:0;background:linear-gradient(180deg, rgba(8,12,16,1) 0%, rgba(10,14,18,0.9) 50%, rgba(2,6,8,1) 100%);color:#9feee0;font-family:system-ui, -apple-system;display:flex;align-items:center;justify-content:center}
          .box{padding:18px;text-align:center}
          h2{margin:0 0 6px;font-size:20px}
          p{margin:0;opacity:.9}
        </style>
        </head><body><div class="box"><h2>${escapeHtml(g.title)}</h2><p>${escapeHtml(g.desc)}</p><div style="margin-top:12px;opacity:.75;font-size:13px">This is an embedded placeholder preview.</div></div></body></html>`;

      if(iframe._blobUrl){
        URL.revokeObjectURL(iframe._blobUrl);
        iframe._blobUrl = null;
      }
      const blob = new Blob([previewHtml], { type: 'text/html' });
      const blobUrl = URL.createObjectURL(blob);
      iframe._blobUrl = blobUrl;
      iframe.src = blobUrl;
    }

    // set title and show modal
    titleEl.textContent = g.title || 'Preview';
    modal.setAttribute('aria-hidden','false');

    function closeModal(){
      modal.setAttribute('aria-hidden','true');
      try {
        if(iframe._blobUrl) {
          iframe.src = 'about:blank';
          URL.revokeObjectURL(iframe._blobUrl);
          iframe._blobUrl = null;
        } else {
          try { iframe.src = 'about:blank'; } catch(e){}
        }
      } catch(e){}
      try { cardEl.style.width = ''; cardEl.style.height = ''; } catch(e){}
    }

    const closeBtn = modal.querySelector('.close');
    if(closeBtn) closeBtn.focus();
  }

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  // live filtering
  let last = '';
  search.addEventListener('input', (e)=>{
    const v = e.target.value || '';
    if(v===last) return;
    last = v;
    renderGrid(v);
  });

  // initial render
  renderGrid();

  // allow programmatic additions
  window.__addApp = function(key,data){
    if(!key||!data) return;
    apps[key]=Object.assign({title:key,desc:''},data);
    renderGrid(search.value);
  };
})();
</script>

<script>
  // Back button: request the parent to remove any fullscreen iframe when embedded,
  // then navigate this window to the homepage (/index.html) in the same tab.
  (function(){
    const btn = document.getElementById('back-to-main');
    if(!btn) return;
    btn.addEventListener('click', () => {
      try {
        if (window.parent && window.parent !== window) {
          try {
            window.parent.postMessage({ type: 'close-preview', source: 'apps-page' }, '*');
          } catch (e) {}
        }

        const iframe = document.getElementById('__search_full_iframe');
        if (iframe && iframe.parentNode) {
          try { iframe.parentNode.removeChild(iframe); } catch (e) {}
        }

        try { window.location.href = '/index.html'; } catch (e) {
          try {
            if (window.history && window.history.length > 1) window.history.back();
          } catch (err){}
        }
      } catch (e) {
        try {
          if (window.history && window.history.length > 1) window.history.back();
          else window.location.href = '/index.html';
        } catch (err) {}
      }
    }, { passive: true });
  })();
</script>

<!-- include site background script so the shared animated canvas runs -->
<script type="module" src="../main.js"></script>
</body>
</html>